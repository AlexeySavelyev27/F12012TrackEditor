# Формат PSSG (архив EGO Engine) и руководство по созданию редактора

## Общее описание формата

Файлы с расширением `.pssg` (а также `.ens`) представляют собой бинарные **архивы ресурcов** игрового движка EGO Engine. Внутри них хранится иерархическая структура данных, включающая 3D‑модели, текстуры, материалы и прочие элементы сцены. Формат PSSG по сути является бинарным аналогом древовидного XML: он содержит **узлы** (nodes) с именами и набором **атрибутов**, а также двоичные блобы данных (например, буферы модели или изображения текстур).

**Ключевые свойства формата:**

* **Сигнатура:** первые 4 байта — ASCII «`PSSG`».
* **Big‑endian:** все многобайтовые числа пишутся в big‑endian.
* **Секция схемы:** в начале файла хранится словарь, сопоставляющий именам узлов/атрибутов их числовые ID.
* **Дерево узлов:** далее следует рекурсивная структура узлов. Каждый хранит: `NodeID`, `NodeSize`, `AttrBlockSize`, блок атрибутов, затем либо подпапки‑узлы, либо бинарные данные.
* **Сжатие:** иногда поток PSSG предварительно сжат GZip (файл тогда начинается с 0x1F 8B). В Melbourne все файлы несжаты.
* **NodeSize/AttrBlockSize:** абсолютны; любая ошибка в этих полях делает файл нечитаемым.

---

## Структура файла

```
+–[Header]–+–[Schema]–+–[Nodes Tree]–+
```

### 1. Заголовок

| Смещение | Размер | Описание          |
|----------|--------|-------------------|
| 0x00     | 4      | ASCII `"PSSG"`    |
| 0x04     | 4      | UInt32 `FileDataLength = FileSize – 8` |

### 2. Секция схемы (Dictionary)

| Поле                | Тип/размер | Комментарий                                          |
|---------------------|-----------|------------------------------------------------------|
| AttributeInfoCount  | UInt32    | Сколько *записей* об атрибутах в схеме               |
| NodeInfoCount       | UInt32    | Сколько *типов узлов* в схеме                        |
| NodeInfo[]          | —         | Повторяется `NodeInfoCount` раз (см. ниже)           |

**NodeInfo**

```
UInt32   NodeID
UInt32   NameLen
bytes    NodeName (UTF‑8)
UInt32   AttrCount
repeat AttrCount times:
    UInt32 AttrID
    UInt32 AttrNameLen
    bytes  AttrName (UTF‑8)
```

### 3. Блок узлов

Каждый узел:

```
UInt32 NodeID         ; ссылка на схему
UInt32 NodeSize       ; длина всего узла после этого поля
UInt32 AttrBlockSize  ; длина секции атрибутов
bytes  AttrBlock      ; последовательность записей атрибутов
bytes  Payload        ; либо дочерние узлы, либо бинарный blob
```

**Запись атрибута**

```
UInt32 AttrID
UInt32 ValueSize
bytes  Value
```

*Если узел содержит подпапки, `Payload` состоит из подряд идущих узлов; иначе это blob‑данные узла.*

---

## Типы данных атрибутов

| ValueSize | Интерпретация                         |
|-----------|---------------------------------------|
| 1         | bool / byte                           |
| 2         | Int16 / UInt16                        |
| 4         | Int32 / UInt32 / Float               |
| ≥8        | 4 байта длины + UTF‑8 строка **или** массив чисел/байт |

Blob‑узлы (пиксели текстур, вершинные/индексные буферы и т.п.) хранят данные как есть.

---

## Пошаговое создание редактора

### 1. Парсинг

1. Проверить «PSSG». При необходимости распаковать GZip.  
2. Прочитать `FileDataLength`.
3. Считать `AttributeInfoCount`, `NodeInfoCount`, затем полностью таблицу схемы — построить словари `nodeId→name`, `attrId→name`.
4. Рекурсивно читать узлы, строя `PSSGNode` (ID, атрибуты, дети, data).

### 2. UI для правки

* Дерево узлов + панель свойств.  
* Изменение значений, добавление/удаление узлов и атрибутов.  
* При любом добавлении нового имени — помечать его для включения в схему.

### 3. Перед сохранением

1. **Перестроить схему** с нуля (пронумеровать узлы и их атрибуты подряд).  
2. **Пересчитать** для каждого узла: `ValueSize` атрибутов → `AttrBlockSize` → `NodeSize` (снизу вверх).  
3. Обновить ссылки ID.

### 4. Сериализация

1. Записать `"PSSG"` + placeholder размера.  
2. Записать новую схему (`AttributeInfoCount`, `NodeInfoCount`, массив `NodeInfo`).  
3. Рекурсивно записать узлы: `NodeID`, `NodeSize`, `AttrBlockSize`, блок атрибутов, затем дочерние узлы или blob.  
4. Вернуться в начало, вписать итоговый `FileDataLength`.

### 5. Критичные проверки

* Big‑endian для **всех** чисел.  
* `NodeSize` и `AttrBlockSize` = фактические.  
* ID в узлах/атрибутах существуют в схеме.  
* Строки: 4‑байтовая длина = фактическая длина в байтах.  
* При замене текстур — обновлять и пиксели, и метаданные `width/height/format`.

---

## Полезные советы

* Не переиспользуйте один `AttrID` для одинаковых имён на разных узлах — оригинальные игры ожидают дублирование.  
* При «нулевом» сохранении полезно иметь режим *byte‑perfect* — редактор читает и пишет файл без изменений (для самотестирования).  
* Храните одновременно и «сырые» байты атрибутов, и их интерпретацию — это упростит безошибочную запись.  
* Расширения `.ens` и `.pssg` взаимозаменяемы — структура идентична.  

---

### Готово — теперь на основе этой спецификации можно реализовать полноценный редактор PSSG.
